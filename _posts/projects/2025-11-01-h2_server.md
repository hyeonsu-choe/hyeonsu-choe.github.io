---
title: H2 Server
description: 리눅스 환경에서 Modern C++(C++17)을 활용하여 개발한 epoll, mmap, NGHTTP2, OpenSSL 기반의 고성능 http/2 서버
author: hyeonsu-choe
date: 2025-10-23 21:45 +0900
last_modified_at: 2025-11-01 16:05 +0900
categories: [Projects, Linux]
tags: [personal, linux, cpp, http/2, epoll, nghttp2, openssl]
toc: true
pin: false
render_with_liquid: false
image:
  path: /assets/img/projects/h2_server/acceptor_worker_overview.png
  # lqip: 
  alt: Structure of http/2 server
---

| 구분 | 내용 |
|:----|:----|
|플랫폼|Linux|
|개발 도구 및 사용 언어|g++ 11.4.0, C++, Socket(epoll), nghttp2 v1.60.0, OpenSSL v3.0.2|
|개발 기간| 2025년 3월 ~ 2025년 10월 |
|저장소| [바로 가기](https://github.com/hyeonsu-choe/h2-server)|


## 1. 개요

![oveview](/assets/img/projects/h2_server/overview.png)

`h2-server`는 **Modern C++(C++17)** 기반의 고성능 **HTTP/2 서버** 이다.  
Linux에서 **epoll(Edge-Triggered)** 로 비동기 통신을 처리하고, **nghttp2 + OpenSSL** 을 통해 HTTP/2의 요청/응답을 처리한다.  
또한 **H2C(평문)** 모드와 **mmap 기반 파일 캐시**를 지원하여 **저지연 업/다운로드** 기능을 제공한다.  
프로그램은 내부적으로 eventfd 기반의 worker 구조로써 acceptor와 worker로 나뉘어져 동작한다.



### 1.1. 빌드

### 1.1.1. 소스 코드 빌드

```bash
# (예) 빌드
cd src
make

# (예) 정리
cd src
make clean
```

### 1.1.2. 도커로 빌드

프로젝트를 도커 이미지로 빌드하려면 **프로젝트 루트(최상위 디렉터리)** 를 다음과 같이 빌드 컨텍스트 위치로 지정해야 한다.  
(`docker_build/`와 `src/`가 함께 위치한 상위 경로)

```bash
docker build -t h2-server -f ./docker_build/Dockerfile .
```

### 1.2. 실행

### 1.2.1. 빌드 후 직접 실행

```bash
# TLS (기본값 포트 443)
cd src
./h2server --port 443 --key ./cert/server.key --cert ./cert/server.crt --threads 4

# H2C (평문)
cd src
./h2server --port 8080 --h2c --threads 4
```

### 1.2.2. 도커로 실행
도커로 실행할 때는 환경 변수로 기본 동작을 제어 한다.

| 환경 변수 | 설명 |
|:--|:--|
| `RUN_MODE` | 실행 모드: `h2`(TLS) 또는 `h2c`(평문) |
| `PORT`     | 서버 리스닝 포트 (예: `443`, `8080`) |
| `THREADS`  | 워커 스레드 수 |

#### 1) 단일 컨테이너 실행

- **TLS(H2) 예시**

```bash
docker run -d --name h2server -e RUN_MODE=h2 -e PORT=443 -e THREADS=4 -p 443:443  h2-server
```

- **평문(H2C) 예시**

```bash
docker run -d --name h2server-h2c -e RUN_MODE=h2c -e PORT=8080 -e THREADS=4   -p 8080:8080   h2-server
```

#### 2) `docker compose`로 실행

`docker_build/docker-compose.yml` 예시:

```yaml
  h2_server:
    image: h2-server
    environment:
      - RUN_MODE=h2
      - PORT=443
      - THREADS=4
    ports:
      - 0.0.0.0:443:443
      - :::443:443
```

실행:

```bash
cd docker_build
docker-compose up -d
```

> H2C로 실행하려면 위 compose 파일에서 `RUN_MODE: "h2c"`, `PORT: "8080"`, `ports: ["8080:8080"]` 로 변경 하면 된다.


### 1.3 핸들러 사용법

#### 등록

```cpp
server.add_handler(GET,  "/files/{file_name}", downloader);
server.add_handler(POST, "/files",            uploader);
```

#### Request API

| 함수                   | 설명                                               |
|:-----------------------|:---------------------------------------------------|
| `reply_ok()`           | 바디 없이 `:status=200` 응답 전송                  |
| `reply_ok_with_file()` | `FileContext`를 data source로 연결해 파일 응답     |
| `reply_404()`          | 간단한 404 HTML 바디와 함께 `:status=404` 전송     |

#### 예시

```cpp
int downloader(Request& request) {
    StreamData* stream_data = request.stream_data;
    const std::string& rel_path = request.rel_path;

    if (rel_path.empty()) {
        return request.reply_404();
    }
    auto file = load_file_from_filecache(rel_path);
    if (!file) {
        return request.reply_404();
    }

    stream_data->file_ctx.data = file->get_data();
    stream_data->file_ctx.size = file->get_data_len();
    return request.reply_ok_with_file();
}
```


## 2. 자료 구조 (Data Structure Overview)

![uml](/assets/img/projects/h2_server/class_diagram.png)


### 2.1. 주요 자료 구조

**1) `StreamData` — 스트림 레벨 컨텍스트**
```cpp
class StreamData {
public:
    uint32_t stream_id;
    METHOD method;
    std::string request_path;
    FileContext file_ctx;
    std::unique_ptr<MultipartFormParser> mime_parser;
    std::vector<uint8_t> upload_file_buffer;
};
```

**2) `SessionData` — 세션(소켓) 레벨 컨텍스트**
```cpp
class SessionData {
public:
    const Router* router;
    std::list<std::unique_ptr<StreamData>> streams;
    nghttp2_session* session;
    std::vector<uint8_t> output_buffer;
    std::vector<uint8_t> input_buffer;
    uint32_t events;
    SessionState state;
    SSL* ssl;
};
```

**3) `Server` — accept/분배 + 워커 관리**
```cpp
class Server {
private:
    Router router;
    std::vector<Worker> workers;
    std::vector<std::thread> threads;
    uint8_t load_count;
    int epfd, server_sock;
    struct sockaddr_in addr;
};
```

**4) `Worker` — 이벤트 루프 & nghttp2/TLS I/O**
```cpp
class Worker {
private:
    const Router* router;
    std::function<bool(uint32_t)> check_rd_hup;
    std::function<void(int, std::shared_ptr<SessionData>)> update_events;
    std::function<IOResult(int, std::shared_ptr<SessionData>)> fill_input_buffer;
    std::function<IOResult(int, std::shared_ptr<SessionData>)> flush_output_buffer;

    std::mutex m;
    int signal_fd, epfd;
    bool use_tls;
    SSL_CTX* ssl_ctx;

    std::queue<int> socket_queue;
    std::unordered_map<int, std::shared_ptr<SessionData>> session_map;
};
```

**5) `Router` — 정적/파라미터 경로 트리**
```cpp
class RouterNode {
public:
    std::unordered_map<std::string, std::unique_ptr<RouterNode>> static_children;
    std::unique_ptr<RouterNode> param_child;      // 같은 레벨에서 파라미터 노드는 1개 제한
    std::string param_child_name;                 // ex) "{id}" -> "id"
    std::array<Handler, METHOD_MAX> handlers;     // GET/POST 등
};

class Router {
private:
    RouterNode root_node;
};
```

**6) File Cache — mmap 기반 zero-copy 지향**
```cpp
class FileContext {
public:
    size_t size;
    int offset;
    const char* data;
};

class MappedFile {
public:
    void*  data;     // mmap 주소
    size_t data_len;
};
```

---

## 3. 모듈 구조 (Module Architecture)

아래는 모듈 간 주요 데이터 플로우이다.   

![module flow](/assets/img/projects/h2_server/modules_flow.png)

### 3.1. Server

- `--threads` 개수만큼 Worker 생성 및 초기화
- accept된 클라이언트 소켓을 **라운드 로빈**으로 각 Worker 큐에 분배  
  (eventfd를 통해 워커를 깨워 즉시 처리)

### 3.2. Worker

- 큐로 전달받은 소켓을 epoll에 등록하고, **TLS 핸드셰이크(옵션)** → **nghttp2 세션**을 초기화
- 이벤트 처리:
  - `handle_read`: `fill_input_buffer` → `feed_input_buffer(nghttp2_session_mem_recv2)` → 콜백 체인
  - `handle_write`: `fill_output_buffer(nghttp2_session_mem_send2)` → `flush_output_buffer`
  - `check_rd_hup`: FIN(RDHUP) 감지 시 안전 종료

#### 3.2.1 .nghttp2 주요 콜백

| 콜백 | 의미 | 트리거 |
|:--|:--|:--|
| `on_begin_headers_callback` | 헤더 블록 수신 시작 | `mem_recv2()` 중 |
| `on_header_callback` | 헤더 name/value 수신 | 헤더마다 반복 |
| `on_data_chunk_recv_callback` | DATA 바디 청크 수신 | DATA 수신 중 반복 |
| `on_frame_recv_callback` | 프레임 수신 완료 | 요청 완결 시 Router→Handler 호출 |
| `on_stream_close_callback` | 스트림 종료 | 정상/에러 종료 시 |


#### 3.2.2. worker 내 buffer 처리와 nghttp2 callback 함수들의 호출 flow

---

```
[Client]  
   │
   ▼  
fill_input_buffer()
   │
   ▼
nghttp2_session_mem_recv2()  ← (HEADERS/DATA 프레임 파싱)
   │
   ├─ on_begin_headers_callback()
   ├─ on_header_callback()
   ├─ on_frame_recv_callback() → Router.resolve() → Handler 실행
   ├─ on_data_chunk_recv_callback (DATA 프레임 수신 시)
   └─ on_stream_close_callback (스트림 close 요청 수신 시)
   │
   ▼
nghttp2_submit_response2() - (전송할 응답 프레임 큐잉, data_prd 존재 시 DATA 프레임 생성)
   │
   ▼
nghttp2_session_mem_send2()  ← (응답 직렬화)
   │
   └─ file_read_callback() (파일 DATA 채움)
   │
   ▼
flush_output_buffer()
   │
   ▼
[Client]
```


#### 3.2.2 TLS(SSL_CTX)

- ALPN 협상에서 **`h2`만 수락**(미지원 시 종료)
- TLS 미사용(H2C) 모드에서는 협상 생략

### 3.3 Router

다음 4개 경로가 등록되면 트리는 다음과 같은 형태로 구성된다.

```text
POST /files/images/{file_name} : handler_b
GET  /files/docs/{file_name}   : handler_c
POST /users/{user_num}         : handler_d
GET  /files/images/{file_name} : handler_a
```

![routing_tree](/assets/img/projects/h2_server/routing_tree.png)

- 정적 경로 우선 → 없으면 파라미터 경로 탐색
- 핸들러는 **프로그램 구동 시에만 등록**(런타임엔 읽기 전용)

### 3.4 File Cache

![filecache](/assets/img/projects/h2_server/filecache.png)

- 디스크 병목 완화 목적의 **mmap 캐시**  
- *주의*: 동일 파일에 대한 동시 쓰기 시 **경쟁/일관성 문제**가 발생할 수 있으므로 운영 시 동기화 정책이 필요하다.

### 3.5 Multipart Form Parser

- 업로드 요청 처리: `multipart/form-data` → 파일 추출
- 플로우: **boundary 파싱 → filename 추출 → temp 쓰기 → 종료 시 rename**
- temp 파일명: `h2_tmp_<thread_id>_<count>`

### 3.6 Config Option

| Flag | Type / Default | Description |
|---|---|---|
| `-p, --port <NUM>` | integer / `443` | 리스닝 포트 |
| `-k, --key <PATH>` | path / `./cert/server.key` | TLS 개인키(PEM). `--h2c`면 불필요 |
| `-c, --cert <PATH>` | path / `./cert/server.crt` | TLS 인증서(PEM). `--h2c`면 불필요 |
| `-n, --threads <NUM>` | integer / `1` | 워커 스레드 수 |
| `--h2c` | flag | HTTP/2 cleartext 모드 |
| `-h, --help` | flag | 도움말 출력 |

---

## 4. 성능 측정 (Benchmark)

### 4.1 개선 단계별 성능 변화
`Prototype → mmap(파일 캐시) → TLS(https) → Router → socket port reuse 멀티스레딩 → acceptor/worker 멀티스레딩`

> 주: mmap 도입 전 `-c1000 -m100`에서는 FD 제한(기본 1024)으로 성공률이 0.1%에 불과.  
> 동일 이슈는 `libevent-server`, `nghttpd(≥8 threads)`에서도 관측되어 `ulimit -n` 상향으로 대응.

#### 1) h2load -c100 -m10

---

| Server  | QPS  | P99 Latency (ms)  | P90 Latency (ms)  | P50 Latency (ms)  | CPU Usage (%)  | Mem Usage (MB)  |
|:---|:---|:---|:---|:---|:---|:---|
| Prototype  | 122060.232  | 10.674  | 8.9248  | 8.0674  | 98.412  | 7.451171875  |
| with MMAP (h2c)  | 224543.5  | 3.7808  | 2.9148  | 2.4816  | 89.632  | 20.30703125  |
| with MMAP + TLS  | 190543.634  | 6.327  | 4.626  | 3.074  | 92.728  | 15.84726563  |
| Router (TLS)  | 175203.934  | 7.3868  | 5.8176  | 4.7424  | 98.974  | 15.94824219  |
| Router (h2c)  | 199643.8  | 0.006327  | 0.004626  | 0.003074  | 92.728  | 0.015475845  |

![http2 서버 스크린샷 1](/assets/img/projects/h2_server/improve_1.png)  
![http2 서버 스크린샷 2](/assets/img/projects/h2_server/improve_2.png)  
![http2 서버 스크린샷 3](/assets/img/projects/h2_server/improve_3.png)  
![http2 서버 스크린샷 4](/assets/img/projects/h2_server/improve_4.png)  


#### 2) h2load -c1000 -m100

---

| Server  | QPS  | P99 Latency (ms)  | P90 Latency (ms)  | P50 Latency (ms)  | CPU Usage (%)  | Mem Usage (MB)  |
|:---|:---|:---|:---|:---|:---|:---|
| Prototype  | 108745.666  | 968.666  | 891.9512  | 740.1804  | 85.978  | 76.84316406  |
| with MMAP (h2c)  | 361051.334  | 290.2608  | 276.253  | 270.2988  | 99.236  | 84.17207031  |
| with MMAP + TLS  | 340922.308  | 324.6172  | 290.5728  | 277.5948  | 99.892  | 125.9441406  |
| Router (TLS)  | 218128.414  | 505.9948  | 473.1074  | 458.968  | 99.81  | 140.4175781  |
| Router (h2c)  | 226110.666  | 486.169  | 453.9088  | 448.7806  | 99.536  | 98.51445313  |

![http2 서버 스크린샷 5](/assets/img/projects/h2_server/improve2_1.png)  
![http2 서버 스크린샷 6](/assets/img/projects/h2_server/improve2_2.png)  
![http2 서버 스크린샷 7](/assets/img/projects/h2_server/improve2_3.png)  
![http2 서버 스크린샷 8](/assets/img/projects/h2_server/improve2_4.png)  


# 4.1.1 Socket Port Reusing vs Acceptor/Worker

## 개요
`SO_REUSEPORT` 옵션을 사용하면 동일한 포트 번호에 대해 **여러 개의 리스닝 소켓을 동시에 bind** 할 수 있다.  
본 HTTP/2 서버 아키텍처에서는 다음 두 가지 모델을 비교하였다.

- **Socket Port Reusing 방식**
- **Acceptor/Worker 방식**


## Socket Port Reusing 방식

![http2 서버 스크린 57](/assets/img/projects/h2_server/socket_port_reuse_overview.png)

> **참고:** Socket Port Reusing 방식은 현재 버전의 구조를 갖추기 이전에 사용되었던 설계이며,  
> 해당 구현은 **커밋 해시 `e4c03916b3ca61d2a82fe72fe4b67f0ddd75ab05`** 에 포함되어 있다.


### 특징
- 각 스레드 또는 프로세스가 **독립적인 리스닝 소켓**을 생성하고 `SO_REUSEPORT`를 설정함.
- 커널은 동일 포트에 바인딩된 소켓들을 **reuseport 그룹**으로 묶어 관리.
- 커널이 **접속 요청을 리스닝 소켓 단위로 로드밸런싱**해 분배함.

### 장점
- 구현 난이도가 매우 낮고 구조가 단순함.
- Accept 경합을 줄여 **락 경쟁이 거의 없음**.
- 커널 네이티브 로드밸런싱을 통해 고성능 구현 가능.

### 단점
- 로드밸런싱 정책이 “커널 해시 기반”으로 제한됨.
- 서버 구조가 커지면 역할 분리·모듈성 측면에서 확장성이 떨어짐.
- 애플리케이션 레벨에서 연결 분배를 직접 제어하기 어려움.

---

## Acceptor/Worker 방식

![http2 서버 스크린 58](/assets/img/projects/h2_server/acceptor_worker_overview.png)

### 특징
- **Acceptor 스레드**
  - 오직 `accept()`만 담당  
  - 새 연결 생성 후 그 FD를 worker에 전달
- **Worker 스레드**
  - Session(HTTP/2 프레임 처리, SSL, I/O 등) 전담

### 장점
- **역할 분리**가 명확해 구조적 일관성/가독성 우수.
- 애플리케이션 레벨에서 connection dispatch 전략을 자유롭게 설계 가능.
- 확장성·유지보수성이 매우 높음.
- 적절한 구현 시 socket reuseport 방식과 **근사한 성능** 확보 가능.

### 단점
- 구현 복잡도가 socket reuseport 방식보다 높음.
- inter-thread communication(파이프/lock-free 큐 등) 필요.

---

## 결론
두 구조는 성능적으로 유사하지만, 본 프로젝트에서는 다음 이유로 **Acceptor/Worker 구조를 최종 채택**하였다.

- 역할 분리·모듈성 우수(서버 책임 분산) 
- 성능 근사 및 유지보수 용이  
- 구조 확장에 유리  
- Session 핸들링 로직이 Worker로 집중되어 코드 명확성 증가  


### 4.1.1.1 H2
### 1) h2load -c100 -m10

**Port reusing**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 170082.768 | 7.8838   | 98.852  | 16.43515625  |
| 2      | 191969.9   | 4.9168   | 138.792 | 15.86367188  |
| 4      | 185166.968 | 4.157    | 146.418 | 15.86210938  |
| 8      | 179178.1275| 3.8758   | 162.196 | 15.91289063  |

**Acceptor/worker**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 186105.4   | 9.0076   | 98.956  | 15.99785156 |
| 2      | 195737.5   | 5.7036   | 143.214 | 15.89492188 |
| 4      | 179277.368 | 3.4026   | 149.856 | 15.87246094 |
| 8      | 183349.368 | 3.3312   | 169.3   | 15.98984375 |

![http2 서버 스크린샷 9](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_1.png)  
![http2 서버 스크린샷 11](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_3.png)  
![http2 서버 스크린샷 13](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_5.png)  
![http2 서버 스크린샷 15](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_7.png) 

---

### 2) h2load -c1000 -m100

**Port reusing**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 220103.334 | 495.8666 | 99.726  | 141.2958984 |
| 2      | 399747.666 | 298.155  | 187.066 | 136         |
| 4      | 421299.026 | 160.2804 | 204.244 | 126.6503906 |
| 8      | 417792.915 | 157.9678 | 209.762 | 126.0441406 |

**Acceptor/worker**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 217159.334 | 510.0868 | 99.846  | 140.0394531 |
| 2      | 389953.44  | 295.7502 | 186.524 | 139.2839844 |
| 4      | 426597.082 | 153.9212 | 208.794 | 128.4552734 |
| 8      | 423505.2   | 148.8116 | 210.396 | 128.0207031 |

![http2 서버 스크린샷 10](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_2.png)  
![http2 서버 스크린샷 12](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_4.png)  
![http2 서버 스크린샷 14](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_6.png)  
![http2 서버 스크린샷 16](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_8.png)  

---

### 4.1.1.2 H2C

### 1) h2load -c100 -m10

**Port reusing**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 196712.666 | 6.9948   | 98.758  | 9.514257813 |
| 2      | 220055.094 | 4.6052   | 146.156 | 9.423828125 |
| 4      | 214679.334 | 3.329    | 151.404 | 9.4296875   |
| 8      | 207702.494 | 3.5508   | 164.488 | 9.51796875  |

**Acceptor/worker**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 199005.834 | 6.3428   | 99.07   | 9.519335938 |
| 2      | 219053.934 | 4.0376   | 140.308 | 9.49453125  |
| 4      | 210013.102 | 3.3358   | 143.344 | 9.295898438 |
| 8      | 209466.56  | 3.5956   | 166.562 | 9.462109375 |

![http2 서버 스크린샷 17](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_1.png)  
![http2 서버 스크린샷 19](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_3.png)  
![http2 서버 스크린샷 21](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_5.png)  
![http2 서버 스크린샷 23](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_7.png)  

### 2) h2load -c1000 -m100

**Port reusing**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 224862.99  | 384.2416 | 99.626  | 76.52480469 |
| 2      | 404943.208 | 307.5908 | 192.06  | 94.28222656 |
| 4      | 438058.332 | 160.4104 | 217.454 | 89.04765625 |
| 8      | 435534     | 156.368  | 218.666 | 81.909375   |

**Acceptor/worker**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|------------:|
| 1      | 225519.504 | 501.1668 | 99.724  | 97.57636719 |
| 2      | 406958.212 | 281.1706 | 187.632 | 94.61152344 |
| 4      | 451179     | 153.3158 | 214.998 | 89.13046875 |
| 8      | 445782.332 | 146.397  | 219.958 | 80.2796875  |

![http2 서버 스크린샷 18](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_2.png)  
![http2 서버 스크린샷 20](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_4.png)  
![http2 서버 스크린샷 22](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_6.png)  
![http2 서버 스크린샷 24](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_8.png)  


## 4.2 서버 프로그램 간 성능 비교

- h2server commit: `d5412ab`  
- nghttpd: nghttp2 v1.60.0  
- libevent-server: nghttp2 v1.60.0

요약:
- `nghttpd`는 스레드 증가에 따른 **메모리 안정성**이 높지만 **성능 스케일링 이득은 제한적**
- `h2server`는 스레드 증가와 함께 **CPU/메모리 사용량이 증가**하나 **처리량도 동반 증가**


### 4.2.1. Single Thread
2server, nghttpd, libevent 간 성능을 비교.  
libevent의 경우 h2c 모드를 지원하지 않으므로 h2 테스트에서는 제외.  

### 4.2.1.1. H2

---

### 1) h2load -c100 -m10

| Server  | QPS  | P99 Latency (ms)  | P90 Latency (ms)  | P50 Latency (ms)  | CPU Usage (%)  | Mem Usage (MB)  |
|:---|:---|:---|:---|:---|:---|:---|
| h2server  | 175170.2  | 9.0076  | 6.038  | 4.8724  | 98.956  | 16.00   |
| Libevent-server  | 154655.1  | 10.0716  | 7.1862  | 5.5062  | 98.026  | 15.41   |
| nghttpd  | 186105.4  | 6.5912  | 4.3258  | 2.7888  | 88.06  | 18.29  |

![http2 서버 스크린샷 25](/assets/img/projects/h2_server/h2_serves_cmp_low_1_1.png)  
![http2 서버 스크린샷 26](/assets/img/projects/h2_server/h2_serves_cmp_low_1_2.png)  
![http2 서버 스크린샷 27](/assets/img/projects/h2_server/h2_serves_cmp_low_1_3.png)  
![http2 서버 스크린샷 28](/assets/img/projects/h2_server/h2_serves_cmp_low_1_4.png)  

### 2) h2load -c1000 -m100

| Server  | QPS  | P99 Latency (ms)  | P90 Latency (ms)  | P50 Latency (ms)  | CPU Usage (%)  | Mem Usage (MB)  |
|:---|:---|:---|:---|:---|:---|:---|
| h2server  | 217159.334  | 510.0868  | 484.559  | 458.1346  | 99.846  | 140.04   |
| Libevent-server  | 204798.998  | 541.5324  | 507.1514  | 479.899  | 99.912  | 95.45   |
| nghttpd  | 366110.576  | 293.5366  | 213.9618  | 147.3734  | 88.154  | 112.97  |

![http2 서버 스크린샷 29](/assets/img/projects/h2_server/h2_serves_cmp_high_1_1.png)  
![http2 서버 스크린샷 30](/assets/img/projects/h2_server/h2_serves_cmp_high_1_2.png)  
![http2 서버 스크린샷 31](/assets/img/projects/h2_server/h2_serves_cmp_high_1_3.png)  
![http2 서버 스크린샷 32](/assets/img/projects/h2_server/h2_serves_cmp_high_1_4.png)  
  
### 4.2.1.2. H2C

---

### 1) h2load -c100 -m10

| Server  | QPS  | P99 Latency (ms)  | P90 Latency (ms)  | P50 Latency (ms)  | CPU Usage (%)  | Mem Usage (MB)  |
|:---|:---|:---|:---|:---|:---|:---|
| h2server  | 175170.2  | 9.0076  | 6.038  | 4.8724  | 98.956  | 15.99785156  |
| nghttpd  | 210449.168  | 4.171  | 2.9462  | 2.3744  | 85.882  | 11.84296875  |

![http2 서버 스크린샷 33](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_1.png)  
![http2 서버 스크린샷 34](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_2.png)  
![http2 서버 스크린샷 35](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_3.png)  
![http2 서버 스크린샷 36](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_4.png)  

### 2) h2load -c1000 -m100

| Server  | QPS  | P99 Latency (ms)  | P90 Latency (ms)  | P50 Latency (ms)  | CPU Usage (%)  | Mem Usage (MB)  |
|:---|:---|:---|:---|:---|:---|:---|
| h2server  | 225519.504  | 501.1668  | 466.9302  | 439.5544  | 99.724  | 97.57636719  |
| nghttpd  | 420206.666  | 206.5538  | 157.337  | 117.8936  | 89.842  | 75.659375  |

![http2 서버 스크린샷 37](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_1.png)  
![http2 서버 스크린샷 38](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_2.png)  
![http2 서버 스크린샷 39](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_3.png)  
![http2 서버 스크린샷 40](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_4.png)  
  

### 4.2.2 스레드 스케일링 비교
- `libevent-server`는 멀티스레드 미지원 → 제외
- `nghttpd`는 8스레드에서 FD 부족 이슈 → `ulimit -n 65535`로 상향하여 측정


### 4.2.2.1 H2
### 1) h2load -c100 -m10

**h2server**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 170082.768 | 7.8838   | 98.852  | 16.43515625  |
| 2      | 191969.9   | 4.9168   | 138.792 | 15.86367188  |
| 4      | 185166.968 | 4.157    | 146.418 | 15.86210938  |
| 8      | 179178.1275| 3.8758   | 162.196 | 15.91289063  |

**nghttpd**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 186105.4   | 6.5912   | 88.06   | 18.28730469  |
| 2      | 195737.5   | 5.4682   | 107.43  | 18.24804688  |
| 4      | 179277.368 | 5.672    | 110.728 | 18.58339844  |
| 8      | 183349.368 | 3.9694   | 129.7275| 19.54589844  |

![http2 서버 스크린샷 41](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_1.png)  
![http2 서버 스크린샷 43](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_3.png)  
![http2 서버 스크린샷 45](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_5.png)  
![http2 서버 스크린샷 47](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_7.png)  

---

### 2) h2load -c1000 -m100

**h2server**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 217159.334 | 510.0868 | 99.846  | 140.0394531  |
| 2      | 389953.44  | 295.7502 | 186.524 | 139.2839844  |
| 4      | 426597.082 | 153.9212 | 208.794 | 128.4552734  |
| 8      | 423505.2   | 148.8116 | 210.396 | 128.0207031  |

**nghttpd**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 366110.576 | 293.5366 | 88.154  | 112.9652344  |
| 2      | 402464.334 | 159.732  | 107.372 | 113.3726563  |
| 4      | 399435.666 | 169.6138 | 109     | 113.0642578  |
| 8      | 397154.602 | 176.494  | 121.392 | 112.834375   |

![http2 서버 스크린샷 42](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_2.png)  
![http2 서버 스크린샷 44](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_4.png)  
![http2 서버 스크린샷 46](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_6.png)  
![http2 서버 스크린샷 48](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_8.png)  

---

### 4.2.2.2 H2C
### 1) h2load -c100 -m10

**h2server**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 199005.834 | 6.3428   | 99.07   | 9.519335938  |
| 2      | 219053.934 | 4.0376   | 140.308 | 9.49453125   |
| 4      | 210013.102 | 3.3358   | 143.344 | 9.295898438  |
| 8      | 209466.56  | 3.5956   | 166.562 | 9.462109375  |

**nghttpd**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 210449.168 | 4.171    | 85.882  | 11.84296875  |
| 2      | 206313.768 | 3.5126   | 98.702  | 12.07929688  |
| 4      | 195104.702 | 3.5794   | 99.028  | 12.33457031  |
| 8      | 196596.5762| 3.243748283 | 107.5871667 | 11.62914507 |

![http2 서버 스크린샷 49](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_1.png)  
![http2 서버 스크린샷 51](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_3.png)  
![http2 서버 스크린샷 53](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_5.png)  
![http2 서버 스크린샷 55](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_7.png)  

---

### 2) h2load -c1000 -m100

**h2server**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 225519.504 | 501.1668 | 99.724  | 97.57636719  |
| 2      | 406958.212 | 281.1706 | 187.632 | 94.61152344  |
| 4      | 451179     | 153.3158 | 214.998 | 89.13046875  |
| 8      | 445782.332 | 146.397  | 219.958 | 80.2796875   |

**nghttpd**

| Threads  | QPS  | P99 Latency (ms) | CPU Usage (%)  | Mem Usage (MB) |
|:------:|-----------:|---------:|--------:|-------------:|
| 1      | 420206.666 | 206.5538 | 89.842  | 75.659375    |
| 2      | 423732.334 | 154.1192 | 104.064 | 75.91914063  |
| 4      | 427888.486 | 163.7296 | 111.604 | 76.49355469  |
| 8      | 408979.824 | 168.5544 | 116.088 | 78.06328125  |

![http2 서버 스크린샷 50](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_2.png)   
![http2 서버 스크린샷 52](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_4.png)  
![http2 서버 스크린샷 54](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_6.png)  
![http2 서버 스크린샷 56](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_8.png)  
