---
title: H2 Server
description: ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ Modern C++(C++17)ì„ í™œìš©í•˜ì—¬ ê°œë°œí•œ epoll, mmap, NGHTTP2, OpenSSL ê¸°ë°˜ì˜ ê³ ì„±ëŠ¥ http/2 ì„œë²„
author: hyeonsu-choe
date: 2025-10-23 21:45 +0900
last_modified_at: 2025-11-30 12:53 +0900
categories: [Projects, Linux]
tags: [personal, linux, cpp, http/2, epoll, nghttp2, openssl]
toc: true
pin: false
render_with_liquid: false
image:
  path: /assets/img/projects/h2_server/acceptor_worker_overview.png
  # lqip: 
  alt: Structure of http/2 server
---

| êµ¬ë¶„                   | ë‚´ìš©                                                            |
| :--------------------- | :-------------------------------------------------------------- |
| í”Œë«í¼                 | Linux                                                           |
| ê°œë°œ ë„êµ¬ ë° ì‚¬ìš© ì–¸ì–´ | g++ 11.4.0, C++, Socket(epoll), nghttp2 v1.60.0, OpenSSL v3.0.2 |
| ê°œë°œ ê¸°ê°„              | 2025ë…„ 3ì›” ~ 2025ë…„ 10ì›”                                        |
| ì €ì¥ì†Œ                 | [ë°”ë¡œ ê°€ê¸°](https://github.com/hyeonsu-choe/h2-server)          |


## 1. ê°œìš”

![oveview](/assets/img/projects/h2_server/acceptor_worker_overview.png)

`h2-server`ëŠ” **Modern C++(C++17)** ê¸°ë°˜ì˜ ê³ ì„±ëŠ¥ **HTTP/2 ì„œë²„** ì´ë‹¤.  
Linuxì—ì„œ **epoll(Edge-Triggered)** ë¡œ ë¹„ë™ê¸° í†µì‹ ì„ ì²˜ë¦¬í•˜ê³ , **nghttp2 + OpenSSL** ì„ í†µí•´ HTTP/2ì˜ ìš”ì²­/ì‘ë‹µì„ ì²˜ë¦¬í•œë‹¤.  
ë˜í•œ **H2C(í‰ë¬¸)** ëª¨ë“œì™€ **mmap ê¸°ë°˜ íŒŒì¼ ìºì‹œ**ë¥¼ ì§€ì›í•˜ì—¬ **ì €ì§€ì—° ì—…/ë‹¤ìš´ë¡œë“œ** ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.  
í”„ë¡œê·¸ë¨ì€ ë‚´ë¶€ì ìœ¼ë¡œ eventfd ê¸°ë°˜ì˜ worker êµ¬ì¡°ë¡œì¨ acceptorì™€ workerë¡œ ë‚˜ë‰˜ì–´ì ¸ ë™ì‘í•˜ë©°  
acceptorì—ì„œ workerë¡œì˜ ì‘ì—… ìš”ì²­ì€ load balancerì— ì˜í•´ ë¶„ì‚° ë˜ì–´ SPSC(Single Producer Single Consumer) êµ¬ì¡°ì˜ lock-free íë¥¼ í†µí•´ ì „ë‹¬ ëœë‹¤. 



### 1.1. ë¹Œë“œ

### 1.1.1. ì†ŒìŠ¤ ì½”ë“œ ë¹Œë“œ

```bash
# (ì˜ˆ) ë¹Œë“œ
cd src
make

# (ì˜ˆ) ì •ë¦¬
cd src
make clean
```

### 1.1.2. ë„ì»¤ë¡œ ë¹Œë“œ

í”„ë¡œì íŠ¸ë¥¼ ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ë ¤ë©´ **í”„ë¡œì íŠ¸ ë£¨íŠ¸(ìµœìƒìœ„ ë””ë ‰í„°ë¦¬)** ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ìœ„ì¹˜ë¡œ ì§€ì •í•´ì•¼ í•œë‹¤.  
(`docker_build/`ì™€ `src/`ê°€ í•¨ê»˜ ìœ„ì¹˜í•œ ìƒìœ„ ê²½ë¡œ)

```bash
docker build -t h2-server -f ./docker_build/Dockerfile .
```

### 1.2. ì‹¤í–‰

### 1.2.1. ë¹Œë“œ í›„ ì§ì ‘ ì‹¤í–‰

```bash
# TLS (ê¸°ë³¸ê°’ í¬íŠ¸ 443)
cd src
./h2server --port 443 --key ./cert/server.key --cert ./cert/server.crt --threads 4

# H2C (í‰ë¬¸)
cd src
./h2server --port 8080 --h2c --threads 4
```

### 1.2.2. ë„ì»¤ë¡œ ì‹¤í–‰
ë„ì»¤ë¡œ ì‹¤í–‰í•  ë•ŒëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ê¸°ë³¸ ë™ì‘ì„ ì œì–´ í•œë‹¤.

| í™˜ê²½ ë³€ìˆ˜  | ì„¤ëª…                                  |
| :--------- | :------------------------------------ |
| `RUN_MODE` | ì‹¤í–‰ ëª¨ë“œ: `h2`(TLS) ë˜ëŠ” `h2c`(í‰ë¬¸) |
| `PORT`     | ì„œë²„ ë¦¬ìŠ¤ë‹ í¬íŠ¸ (ì˜ˆ: `443`, `8080`)  |
| `THREADS`  | ì›Œì»¤ ìŠ¤ë ˆë“œ ìˆ˜                        |

#### 1) ë‹¨ì¼ ì»¨í…Œì´ë„ˆ ì‹¤í–‰

- **TLS(H2) ì˜ˆì‹œ**

```bash
docker run -d --name h2server -e RUN_MODE=h2 -e PORT=443 -e THREADS=4 -p 443:443  h2-server
```

- **í‰ë¬¸(H2C) ì˜ˆì‹œ**

```bash
docker run -d --name h2server-h2c -e RUN_MODE=h2c -e PORT=8080 -e THREADS=4   -p 8080:8080   h2-server
```

#### 2) `docker compose`ë¡œ ì‹¤í–‰

`docker_build/docker-compose.yml` ì˜ˆì‹œ:

```yaml
  h2_server:
    image: h2-server
    environment:
      - RUN_MODE=h2
      - PORT=443
      - THREADS=4
    ports:
      - 0.0.0.0:443:443
      - :::443:443
```

ì‹¤í–‰:

```bash
cd docker_build
docker-compose up -d
```

> H2Cë¡œ ì‹¤í–‰í•˜ë ¤ë©´ ìœ„ compose íŒŒì¼ì—ì„œ `RUN_MODE: "h2c"`, `PORT: "8080"`, `ports: ["8080:8080"]` ë¡œ ë³€ê²½ í•˜ë©´ ëœë‹¤.


### 1.3 í•¸ë“¤ëŸ¬ ì‚¬ìš©ë²•

#### ë“±ë¡

```cpp
server.add_handler(GET,  "/files/{file_name}", downloader);
server.add_handler(POST, "/files",            uploader);
```

#### Request API

| í•¨ìˆ˜                   | ì„¤ëª…                                           |
| :--------------------- | :--------------------------------------------- |
| `reply_ok()`           | ë°”ë”” ì—†ì´ `:status=200` ì‘ë‹µ ì „ì†¡              |
| `reply_ok_with_file()` | `FileContext`ë¥¼ data sourceë¡œ ì—°ê²°í•´ íŒŒì¼ ì‘ë‹µ |
| `reply_404()`          | ê°„ë‹¨í•œ 404 HTML ë°”ë””ì™€ í•¨ê»˜ `:status=404` ì „ì†¡ |

#### ì˜ˆì‹œ

```cpp
int downloader(Request& request) {
    StreamData* stream_data = request.stream_data;
    const std::string& rel_path = request.rel_path;

    if (rel_path.empty()) {
        return request.reply_404();
    }
    auto file = load_file_from_filecache(rel_path);
    if (!file) {
        return request.reply_404();
    }

    stream_data->file_ctx.data = file->get_data();
    stream_data->file_ctx.size = file->get_data_len();
    return request.reply_ok_with_file();
}
```


## 2. ìë£Œ êµ¬ì¡° (Data Structure Overview)

![uml](/assets/img/projects/h2_server/class_diagram.png)


### 2.1. ì£¼ìš” ìë£Œ êµ¬ì¡°

**1) `StreamData` â€” ìŠ¤íŠ¸ë¦¼ ë ˆë²¨ ì»¨í…ìŠ¤íŠ¸**
```cpp
class StreamData {
public:
    uint32_t stream_id;
    METHOD method;
    std::string request_path;
    FileContext file_ctx;
    std::unique_ptr<MultipartFormParser> mime_parser;
    std::vector<uint8_t> upload_file_buffer;
};
```

**2) `SessionData` â€” ì„¸ì…˜(ì†Œì¼“) ë ˆë²¨ ì»¨í…ìŠ¤íŠ¸**
```cpp
class SessionData {
public:
    const Router* router;
    std::list<std::unique_ptr<StreamData>> streams;
    nghttp2_session* session;
    std::vector<uint8_t> output_buffer;
    std::vector<uint8_t> input_buffer;
    uint32_t events;
    SessionState state;
    SSL* ssl;
};
```

**3) `Server` â€” accept/ë¶„ë°° + ì›Œì»¤ ê´€ë¦¬**
```cpp
class Server {
private:
    Router router;
    std::vector<Worker> workers;
    std::vector<std::thread> threads;
    LoadBalancer load_balancer;
    int epfd, server_sock;
    struct sockaddr_in addr;
};
```

**4) `Worker` â€” ì´ë²¤íŠ¸ ë£¨í”„ & nghttp2/TLS I/O**
```cpp
class Worker {
private:
    const Router* router;
    std::function<bool(uint32_t)> check_rd_hup;
    std::function<void(int, std::shared_ptr<SessionData>)> update_events;
    std::function<IOResult(int, std::shared_ptr<SessionData>)> fill_input_buffer;
    std::function<IOResult(int, std::shared_ptr<SessionData>)> flush_output_buffer;

    std::mutex m;
    int signal_fd, epfd;
    bool use_tls;
    SSL_CTX* ssl_ctx;

    std::queue<int> socket_queue;
    std::unordered_map<int, std::shared_ptr<SessionData>> session_map;
};
```

**5) `Router` â€” ì •ì /íŒŒë¼ë¯¸í„° ê²½ë¡œ íŠ¸ë¦¬**
```cpp
class RouterNode {
public:
    std::unordered_map<std::string, std::unique_ptr<RouterNode>> static_children;
    std::unique_ptr<RouterNode> param_child;      // ê°™ì€ ë ˆë²¨ì—ì„œ íŒŒë¼ë¯¸í„° ë…¸ë“œëŠ” 1ê°œ ì œí•œ
    std::string param_child_name;                 // ex) "{id}" -> "id"
    std::array<Handler, METHOD_MAX> handlers;     // GET/POST ë“±
};

class Router {
private:
    RouterNode root_node;
};
```

**6) File Cache â€” mmap ê¸°ë°˜ zero-copy ì§€í–¥**
```cpp
class FileContext {
public:
    size_t size;
    int offset;
    const char* data;
};

class MappedFile {
public:
    void*  data;     // mmap ì£¼ì†Œ
    size_t data_len;
};
```

---

## 3. ëª¨ë“ˆ êµ¬ì¡° (Module Architecture)

ì•„ë˜ëŠ” ëª¨ë“ˆ ê°„ ì£¼ìš” ë°ì´í„° í”Œë¡œìš°ì´ë‹¤.   

![module flow](/assets/img/projects/h2_server/modules_flow.png)

### 3.1. Server

- `--threads` ê°œìˆ˜ë§Œí¼ Worker ìƒì„± ë° ì´ˆê¸°í™”
- acceptëœ í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ì„ **LoadBalancer**ë¥¼ ì´ìš©í•˜ì—¬ ê° Worker íì— ë¶„ë°°  
  (eventfdë¥¼ í†µí•´ ì›Œì»¤ë¥¼ ê¹¨ì›Œ ì¦‰ì‹œ ì²˜ë¦¬)


### 3.1.1. LoadBalancer

ë‹¤ìŒì€ Server ë‚´ì— ìœ„ì¹˜í•˜ì—¬ ì…ë ¥ë˜ëŠ” client ì—°ê²° ìš”ì²­ì„ ë°›ì•„ ê° Workerë¡œ ë¶„ë°°í•˜ëŠ” ë¡œë“œ ë°¸ëŸ°ì„œì´ë‹¤.  

![load_balancer](/assets/img/projects/h2_server/load_balancer.png)



ë¡œë“œ ë°¸ëŸ°ì„œëŠ” ì…ë ¥ëœ ìš”ì²­ì„ ë°›ì•„ í•´ì‹œ ì—°ì‚°ì„ í†µí•´ `Indirect Table`ì„ ì°¸ì¡°í•˜ì—¬ ìš”ì²­ì„ ì „ë‹¬ í•  Worker Queueì˜ ë²ˆí˜¸ë¥¼ ì–»ëŠ”ë‹¤.   
ì´ë•Œì˜ Worker QueueëŠ” SPSC(Single Producer Single Consumer) êµ¬ì¡°ì˜ lock-free Queue ë¡œì¨,     
ê·¸ Worker Queueì— ì—¬ìœ ê°€ ìˆëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ìš”ì²­ì„ ì „ë‹¬ í•œë‹¤.  
ê·¸ëŸ¬ë‚˜ ë§Œì•½ ì„ íƒëœ Worker Queue ê°€ fullì¸ ê²½ìš°, ë‹¤ë¥¸ ì—¬ìœ ê°€ ìˆëŠ” Worker Queueë¥¼ `Round Robin` ìŠ¤ì¼€ì¥´ë§ì„ í†µí•´ ì°¾ì•„ ì‘ì—…ì„ ìš”ì²­í•œë‹¤.  

ì´ë•Œ, ì„ íƒëœ Worker Queueì˜ ë²ˆí˜¸ëŠ” hash ì—°ì‚°ì„ í†µí•´ ì ‘ê·¼ëœ indirect_tableì˜ entryì— ê°±ì‹  ëœë‹¤.  
ê·¸ë¦¬ê³  ì´í›„ ì´ entryì— ì ‘ê·¼í•˜ëŠ” ìš”ì²­ì€ ìƒˆë¡­ê²Œ ì„ íƒëœ Worker Queueë¡œ ì „ë‹¬ ë˜ê²Œ ëœë‹¤.  

ë§Œì•½, `Round Robin` ìŠ¤ì¼€ì¥´ë§ì„ í†µí•´ Worker Queue ë“¤ì„ í•œ ë°”í€´ ìˆœíšŒ í•˜ì˜€ìŒì—ë„ ì—¬ìœ  ìˆëŠ” Worker Queueë¥¼ ë°œê²¬í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ì—ëŠ” í•´ë‹¹ ìš”ì²­ì€ ë²„ë ¤ì§„ë‹¤.  

- ìƒˆë¡­ê²Œ ìƒì„±ëœ í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ì— ëŒ€í•´ `modular` ì—°ì‚°ì„ ìˆ˜í–‰í•˜ì—¬ indirect_tableì˜ ì¸ë±ìŠ¤ ê°’ìœ¼ë¡œ ë³€í™˜
- indirect_tableì˜ ì—”íŠ¸ë¦¬ì— ìˆëŠ” Worker Queue ë²ˆí˜¸ë¥¼ íšë“  
    - ìµœì´ˆ indirect_tableì—ëŠ” Worker Queueì˜ ë²ˆí˜¸ê°€ ìˆœì„œëŒ€ë¡œ ë°˜ë³µ ì…ë ¥ ë˜ì–´ ìˆë‹¤.  
- Worker Queue ê°€ fullì´ ì•„ë‹ˆë¼ë©´, í•´ë‹¹ worker queueë¡œ í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ì„ ì „ë‹¬í•œë‹¤.  
    - ë§Œì•½ Worker Queue ê°€ full ì¸ ê²½ìš°, `Round Robin` ìŠ¤ì¼€ì¥´ë§ì„ í†µí•´ ì—¬ë¶„ì˜ Worker Queue ë¥¼ ì°¿ëŠ”ë‹¤.  
        - ì´ê²ƒì€ ì¼ì¢…ì˜ fallover ë™ì‘ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.  
        - ì—¬ë¶„ì˜ Worker Queue ë°œê²¬ ì‹œ ë°©ê¸ˆ ì ‘ê·¼ í–ˆë˜ indirect_tableì˜ ì—”íŠ¸ë¦¬ì— Queue ë²ˆí˜¸ ê°’ì„ ê°±ì‹ í•œë‹¤.
        - ìƒˆë¡­ê²Œ ì„ íƒëœ Worker Queueì— í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ì„ ì „ë‹¬ í•œë‹¤.  
    - ë§Œì•½ ì—¬ë ¥ì´ ìˆëŠ” Worker Queue ë¥¼ ë°œê²¬í•˜ì§€ ëª»í•œ ê²½ìš° ìƒì„±ëœ ì†Œì¼“ì„ close í•œë‹¤.

    

### 3.2. Worker

- íë¡œ ì „ë‹¬ë°›ì€ ì†Œì¼“ì„ epollì— ë“±ë¡í•˜ê³ , **TLS í•¸ë“œì…°ì´í¬(ì˜µì…˜)** â†’ **nghttp2 ì„¸ì…˜**ì„ ì´ˆê¸°í™”
- ì´ë²¤íŠ¸ ì²˜ë¦¬:
  - `handle_read`: `fill_input_buffer` â†’ `feed_input_buffer(nghttp2_session_mem_recv2)` â†’ ì½œë°± ì²´ì¸
  - `handle_write`: `fill_output_buffer(nghttp2_session_mem_send2)` â†’ `flush_output_buffer`
  - `check_rd_hup`: FIN(RDHUP) ê°ì§€ ì‹œ ì•ˆì „ ì¢…ë£Œ


#### 3.2.1. worker ë‚´ buffer ì²˜ë¦¬ì™€ nghttp2 callback í•¨ìˆ˜ë“¤ì˜ í˜¸ì¶œ flow

![h2_server_worker_callback_flow](/assets/img/projects/h2_server/h2server_worker_callback_flow.png)

#### 3.2.2. ì£¼ìš” í•¨ìˆ˜ í˜¸ì¶œ ì²´ì¸
| í•¨ìˆ˜ëª…                          | ì˜ë¯¸                 | íŠ¸ë¦¬ê±°                           |
| :---------------------------- | :------------------- | :------------------------------- |
| `fill_input_buffer`   | ì†Œì¼“ì„ í†µí•´ ìˆ˜ì‹ ëœ ë°ì´í„°ë“¤ì„ ì½ì–´ ìˆ˜ì‹  ë²„í¼ì— ì €ì¥  | ìˆ˜ì‹  ì†Œì¼“ì—ì„œ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ                 |
|`feed_input_buffer`| ì±„ì›Œì§„ ìˆ˜ì‹  buffer ë‚´ ë‚´ìš©ì„ nghttp2 ì„¸ì…˜ ë°ì´í„°ë¡œ feed í•  ì¤€ë¹„| ë”ì´ìƒ ì†Œì¼“ì—ì„œ ìˆ˜ì‹ í•  ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° |
| `nghttp2_session_mem_recv2`          | ì±„ì›Œì§„ buffer ë‚´ ë°ì´í„°ë“¤ì„ nghttp2 ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ feed | ìˆ˜ì‹  ë²„í¼ì— ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°  |
| `nghttp2_submit_response2` | ì „ì†¡í•  ì‘ë‹µ í”„ë ˆì„ì„ ì „ì†¡ ëŒ€ê¸°íë¡œ íì‰, data_prd ì¡´ì¬ ì‹œ DATA í”„ë ˆì„ ìƒì„±  | ì‘ë‹µ ë©”ì‹œì§€ ì „ì†¡ì„ ìœ„í•´ ì§ì ‘ í˜¸ì¶œ |
| `nghttp2_session_mem_send2`      | ì „ì†¡ ëŒ€ê¸° í ë‚´ ì‘ë‹µ í”„ë ˆì„ì„ ì „ì†¡ í•  ìˆ˜ ìˆê²Œ ì§ë ¬í™” í™”ì—¬ í¬ì¸í„° ë°˜í™˜ | ì‘ë‹µí•  ìˆ˜ ìˆëŠ” ë°ì´í„° ì¡´ì¬ ì‹œ |
|`fill_ouput_buffer`|í¬ì¸í„°ê°€ ê°€ë¦¬í‚¤ëŠ” ì§ë ¬í™”ëœ ë°ì´í„°ë¥¼ ì¶œë ¥ ë²„í¼ë¡œ ë³µì‚¬||
| `flush_output_buffer`    | ì¶œë ¥ ë²„í¼ ë‚´ ë°ì´í„°ë¥¼ ì†Œì¼“ì„ í†µí•´ ì „ì†¡ |   ì§ì ‘ í˜¸ì¶œ  |


#### 3.2.3 .ì£¼ìš” nghttp2 ì½œë°± í•¨ìˆ˜ë“¤

| í•¨ìˆ˜ëª…                          | ì˜ë¯¸                 | íŠ¸ë¦¬ê±°                           |
| :---------------------------- | :------------------- | :------------------------------- |
| `on_begin_headers_callback`   | í—¤ë” ë¸”ë¡ ìˆ˜ì‹  ì‹œì‘  | `mem_recv2()` ì¤‘                 |
| `on_header_callback`          | í—¤ë” name/value ìˆ˜ì‹  | í—¤ë” ìˆ˜ì‹  ë•Œë§ˆë‹¤ ë°˜ë³µ                    |
| `on_data_chunk_recv_callback` | DATA ë°”ë”” ì²­í¬ ìˆ˜ì‹   | DATA í”„ë ˆì„ ìˆ˜ì‹  ì¤‘ ë°˜ë³µ                |
| `on_frame_recv_callback`      | í”„ë ˆì„ ìˆ˜ì‹  ì™„ë£Œ     | ìš”ì²­ ì™„ë£Œ ì‹œ Routerâ†’Handler í˜¸ì¶œ |
| `on_stream_close_callback`    | ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ          | ìŠ¤íŠ¸ë¦¼ close ìš”ì²­ ìˆ˜ì‹  ì‹œ         |


#### 3.2.2 TLS(SSL_CTX)

- ALPN í˜‘ìƒì—ì„œ **`h2`ë§Œ ìˆ˜ë½**(ë¯¸ì§€ì› ì‹œ ì¢…ë£Œ)
- TLS ë¯¸ì‚¬ìš©(H2C) ëª¨ë“œì—ì„œëŠ” ALPN í˜‘ìƒ ìƒëµ

### 3.3 Router

ë‹¤ìŒ 4ê°œ ê²½ë¡œê°€ ë“±ë¡ë˜ë©´ íŠ¸ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ êµ¬ì„±ëœë‹¤.

```text
POST /files/images/{file_name} : handler_b
GET  /files/docs/{file_name}   : handler_c
POST /users/{user_num}         : handler_d
GET  /files/images/{file_name} : handler_a
```

![routing_tree](/assets/img/projects/h2_server/routing_tree.png)

- ì •ì  ê²½ë¡œ ìš°ì„  â†’ ì—†ìœ¼ë©´ íŒŒë¼ë¯¸í„° ê²½ë¡œ íƒìƒ‰
- í•¸ë“¤ëŸ¬ëŠ” **í”„ë¡œê·¸ë¨ êµ¬ë™ ì‹œì—ë§Œ ë“±ë¡**(ëŸ°íƒ€ì„ì—” ì½ê¸° ì „ìš©)

### 3.4 File Cache

![filecache](/assets/img/projects/h2_server/filecache.png)

- ë””ìŠ¤í¬ ë³‘ëª© ì™„í™” ëª©ì ì˜ **mmap ìºì‹œ**  
- *ì£¼ì˜*: ë™ì¼ íŒŒì¼ì— ëŒ€í•œ ë™ì‹œ ì“°ê¸° ì‹œ **ê²½ìŸ/ì¼ê´€ì„± ë¬¸ì œ**ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìš´ì˜ ì‹œ ë™ê¸°í™” ì •ì±…ì´ í•„ìš”í•˜ë‹¤.

### 3.5 Multipart Form Parser

- ì—…ë¡œë“œ ìš”ì²­ ì²˜ë¦¬: `multipart/form-data` â†’ íŒŒì¼ ì¶”ì¶œ
- í”Œë¡œìš°: **boundary íŒŒì‹± â†’ filename ì¶”ì¶œ â†’ temp ì“°ê¸° â†’ ì¢…ë£Œ ì‹œ rename**
- temp íŒŒì¼ëª…: `h2_tmp_<thread_id>_<count>`

### 3.6 Config Option

| Flag                  | Type / Default             | Description                       |
| --------------------- | -------------------------- | --------------------------------- |
| `-p, --port <NUM>`    | integer / `443`            | ë¦¬ìŠ¤ë‹ í¬íŠ¸                       |
| `-k, --key <PATH>`    | path / `./cert/server.key` | TLS ê°œì¸í‚¤(PEM). `--h2c`ë©´ ë¶ˆí•„ìš” |
| `-c, --cert <PATH>`   | path / `./cert/server.crt` | TLS ì¸ì¦ì„œ(PEM). `--h2c`ë©´ ë¶ˆí•„ìš” |
| `-n, --threads <NUM>` | integer / `1`              | ì›Œì»¤ ìŠ¤ë ˆë“œ ìˆ˜                    |
| `--h2c`               | flag                       | HTTP/2 cleartext ëª¨ë“œ             |
| `-h, --help`          | flag                       | ë„ì›€ë§ ì¶œë ¥                       |

---

## 4. ì„±ëŠ¥ ì¸¡ì • (Benchmark)

### 4.1 ê°œì„  ë‹¨ê³„ë³„ ì„±ëŠ¥ ë³€í™”
`Prototype â†’ mmap(íŒŒì¼ ìºì‹œ) ì ìš© â†’ TLS(https) ì ìš© â†’ Router ì ìš© â†’ socket port reuse ë©€í‹°ìŠ¤ë ˆë”© êµ¬ì¡° ì ìš© â†’ acceptor/worker ë©€í‹°ìŠ¤ë ˆë”© êµ¬ì¡° ì ìš© -> Load Balancer ì `

> ì£¼: mmap ë„ì… ì „ `-c1000 -m100`ì—ì„œëŠ” FD ì œí•œ(ê¸°ë³¸ 1024)ìœ¼ë¡œ ì„±ê³µë¥ ì´ 0.1%ì— ë¶ˆê³¼.  
> ë™ì¼ ì´ìŠˆëŠ” `libevent-server`, `nghttpd(â‰¥8 threads)`ì—ì„œë„ ê´€ì¸¡ë˜ì–´ `ulimit -n` ìƒí–¥ìœ¼ë¡œ ëŒ€ì‘.

#### 1) h2load -c100 -m10

---

| Server             | QPS        | P99 Latency (ms) | P90 Latency (ms) | P50 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :----------------- | :--------- | :--------------- | :--------------- | :--------------- | :------------ | :------------- |
| Prototype          | 122060.232 | 10.674           | 8.9248           | 8.0674           | 98.412        | 7.451171875    |
| with MMAP (h2c)    | 224543.5   | 3.7808           | 2.9148           | 2.4816           | 89.632        | 20.30703125    |
| with MMAP + TLS    | 190543.634 | 6.327            | 4.626            | 3.074            | 92.728        | 15.84726563    |
| Router (TLS)       | 175203.934 | 7.3868           | 5.8176           | 4.7424           | 98.974        | 15.94824219    |
| Router (h2c)       | 199643.8   | 0.006327         | 0.004626         | 0.003074         | 92.728        | 0.015475845    |
| LoadBalancer (TLS) | 173702.098 | 7.306            | 5.9562           | 5.0248           | 99.208        | 18.12          |
| LoadBalancer (h2c) | 192895.766 | 6.7044           | 5.5092           | 4.5218           | 99.078        | 9.565039063    |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 1](/assets/img/projects/h2_server/improve_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 2](/assets/img/projects/h2_server/improve_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 3](/assets/img/projects/h2_server/improve_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 4](/assets/img/projects/h2_server/improve_4.png)  


#### 2) h2load -c1000 -m100

---

| Server              | QPS        | P99 Latency (ms) | P90 Latency (ms) | P50 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :------------------ | :--------- | :--------------- | :--------------- | :--------------- | :------------ | :------------- |
| Prototype           | 108745.666 | 968.666          | 891.9512         | 740.1804         | 85.978        | 76.84316406    |
| with MMAP (h2c)     | 361051.334 | 290.2608         | 276.253          | 270.2988         | 99.236        | 84.17207031    |
| with MMAP + TLS     | 340922.308 | 324.6172         | 290.5728         | 277.5948         | 99.892        | 125.9441406    |
| Router (TLS)        | 218128.414 | 505.9948         | 473.1074         | 458.968          | 99.81         | 140.4175781    |
| Router (h2c)        | 226110.666 | 486.169          | 453.9088         | 448.7806         | 99.536        | 98.51445313    |
| Load Balancer (TLS) | 205574.332 | 547.7828         | 508.3812         | 486.7182         | 99.942        | 141.19         |
| Load Balancer (h2c) | 221886.068 | 514.821          | 474.6454         | 445.1006         | 99.938        | 96.4296875     |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 5](/assets/img/projects/h2_server/improve2_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 6](/assets/img/projects/h2_server/improve2_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 7](/assets/img/projects/h2_server/improve2_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 8](/assets/img/projects/h2_server/improve2_4.png)  


# 4.1.1 Socket Port Reusing vs Acceptor/Worker

## ê°œìš”
`SO_REUSEPORT` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ë™ì¼í•œ í¬íŠ¸ ë²ˆí˜¸ì— ëŒ€í•´ **ì—¬ëŸ¬ ê°œì˜ ë¦¬ìŠ¤ë‹ ì†Œì¼“ì„ ë™ì‹œì— bind** í•  ìˆ˜ ìˆë‹¤.  
ë³¸ HTTP/2 ì„œë²„ ì•„í‚¤í…ì²˜ì—ì„œëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ ëª¨ë¸ì„ ë¹„êµí•˜ì˜€ë‹¤.

- **Socket Port Reusing ë°©ì‹ (ì»¤ë°‹ í•´ì‹œ: `b2985a2d81e4db92e00b7171dd9ebb93b4bc2df3`)**
- **Acceptor/Worker ë°©ì‹ (ì»¤ë°‹ í•´ì‹œ: `db6af3ddcdcf329e5a72bc0df9b7c236284df795`)**

ğŸ’¡ **ì°¸ê³ :** ë³¸ ì ˆì˜ ë‚´ìš©ê³¼ ìˆ˜ì¹˜ëŠ” **Load Balancer ë„ì… ì´ì „ ë²„ì „**ì„ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.  


## Socket Port Reusing ë°©ì‹

![http2 ì„œë²„ ìŠ¤í¬ë¦° 57](/assets/img/projects/h2_server/socket_port_reuse_overview.png)

> **ì°¸ê³ :** Socket Port Reusing ë°©ì‹ì€ í˜„ì¬ ë²„ì „ì˜ êµ¬ì¡°ë¥¼ ê°–ì¶”ê¸° ì´ì „ì— ì‚¬ìš©ë˜ì—ˆë˜ ì„¤ê³„ì´ë©°,  
> í•´ë‹¹ êµ¬í˜„ì€ **ì»¤ë°‹ í•´ì‹œ `e4c03916b3ca61d2a82fe72fe4b67f0ddd75ab05`** ì— í¬í•¨ë˜ì–´ ìˆë‹¤.


### íŠ¹ì§•
- ê° ìŠ¤ë ˆë“œ ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ê°€ **ë…ë¦½ì ì¸ ë¦¬ìŠ¤ë‹ ì†Œì¼“**ì„ ìƒì„±í•˜ê³  `SO_REUSEPORT`ë¥¼ ì„¤ì •í•¨.
- ì»¤ë„ì€ ë™ì¼ í¬íŠ¸ì— ë°”ì¸ë”©ëœ ì†Œì¼“ë“¤ì„ **reuseport ê·¸ë£¹**ìœ¼ë¡œ ë¬¶ì–´ ê´€ë¦¬.
- ì»¤ë„ì´ **ì ‘ì† ìš”ì²­ì„ ë¦¬ìŠ¤ë‹ ì†Œì¼“ ë‹¨ìœ„ë¡œ ë¡œë“œë°¸ëŸ°ì‹±**í•´ ë¶„ë°°í•¨.

### ì¥ì 
- êµ¬í˜„ ë‚œì´ë„ê°€ ë‚®ê³  êµ¬ì¡°ê°€ ë‹¨ìˆœí•¨.
- Accept ê²½í•©ì„ ì¤„ì—¬ **ë½ ê²½ìŸì´ ê±°ì˜ ì—†ìŒ**.
- ì»¤ë„ ë‚´ì—ì„œ ë¡œë“œë°¸ëŸ°ì‹±ì´ ìˆ˜í–‰ ë¨.

### ë‹¨ì 
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì—°ê²° ë¶„ë°°ë¥¼ ì§ì ‘ ì œì–´í•˜ê¸° ì–´ë ¤ì›€.
- ì„œë²„ êµ¬ì¡°ê°€ ì»¤ì§€ë©´ ì—­í•  ë¶„ë¦¬Â·ëª¨ë“ˆì„± ì¸¡ë©´ì—ì„œ í™•ì¥ì„±ì´ ë–¨ì–´ì§.

---

## Acceptor/Worker ë°©ì‹

![http2 ì„œë²„ ìŠ¤í¬ë¦° 58](/assets/img/projects/h2_server/acceptor_worker_overview.png)



### íŠ¹ì§•
- **Acceptor ìŠ¤ë ˆë“œ**
  - ì˜¤ì§ `accept()`ë§Œ ë‹´ë‹¹  
  - ìƒˆ ì—°ê²° ìƒì„± í›„ ê·¸ FDë¥¼ workerì— ì „ë‹¬
- **Worker ìŠ¤ë ˆë“œ**
  - Session(HTTP/2 í”„ë ˆì„ ì²˜ë¦¬, SSL, I/O ë“±) ì „ë‹´

### ì¥ì 
- **ì—­í•  ë¶„ë¦¬**ê°€ ëª…í™•í•´ êµ¬ì¡°ì  ì¼ê´€ì„±/ê°€ë…ì„± ìš°ìˆ˜.
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ connection dispatch ì „ëµì„ ììœ ë¡­ê²Œ ì„¤ê³„ ê°€ëŠ¥.
- í™•ì¥ì„± ë° ìœ ì§€ë³´ìˆ˜ì„±ì´ ë§¤ìš° ë†’ìŒ.

### ë‹¨ì 
- êµ¬í˜„ ë³µì¡ë„ê°€ socket reuseport ë°©ì‹ë³´ë‹¤ ë†’ìŒ.
- inter-thread communication(íŒŒì´í”„/lock-free í ë“±) í•„ìš”.

---

## ê²°ë¡ 
ë‘ êµ¬ì¡°ëŠ” ì„±ëŠ¥ì ìœ¼ë¡œ ìœ ì‚¬í•˜ì§€ë§Œ, ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì´ìœ ë¡œ **Acceptor/Worker êµ¬ì¡°**ë¥¼ íƒí•¨.

- ì—­í•  ë¶„ë¦¬ ë° ëª¨ë“ˆì„± ìš°ìˆ˜
- ìœ ì§€ë³´ìˆ˜ ìš©ì´  
- êµ¬ì¡° í™•ì¥ì— ìœ ë¦¬  
- Session í•¸ë“¤ë§ ë¡œì§ì´ Workerë¡œ ì§‘ì¤‘ë˜ì–´ ì½”ë“œ ê°€ë…ì„± ë° ëª…í™•ì„± ì¦ê°€  


### 4.1.1.1 H2
### 1) h2load -c100 -m10

**Port reusing**

| Threads |         QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ----------: | ---------------: | ------------: | -------------: |
|    1    |  170082.768 |           7.8838 |        98.852 |    16.43515625 |
|    2    |    191969.9 |           4.9168 |       138.792 |    15.86367188 |
|    4    |  185166.968 |            4.157 |       146.418 |    15.86210938 |
|    8    | 179178.1275 |           3.8758 |       162.196 |    15.91289063 |

**Acceptor/worker**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    |   186105.4 |           9.0076 |        98.956 |    15.99785156 |
|    2    |   195737.5 |           5.7036 |       143.214 |    15.89492188 |
|    4    | 179277.368 |           3.4026 |       149.856 |    15.87246094 |
|    8    | 183349.368 |           3.3312 |         169.3 |    15.98984375 |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 9](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 11](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 13](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_5.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 15](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_7.png) 

---

### 2) h2load -c1000 -m100

**Port reusing**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 220103.334 |         495.8666 |        99.726 |    141.2958984 |
|    2    | 399747.666 |          298.155 |       187.066 |            136 |
|    4    | 421299.026 |         160.2804 |       204.244 |    126.6503906 |
|    8    | 417792.915 |         157.9678 |       209.762 |    126.0441406 |

**Acceptor/worker**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 217159.334 |         510.0868 |        99.846 |    140.0394531 |
|    2    |  389953.44 |         295.7502 |       186.524 |    139.2839844 |
|    4    | 426597.082 |         153.9212 |       208.794 |    128.4552734 |
|    8    |   423505.2 |         148.8116 |       210.396 |    128.0207031 |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 10](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 12](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_4.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 14](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_6.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 16](/assets/img/projects/h2_server/h2_sock_re_acpt_worker_8.png)  

---

### 4.1.1.2 H2C

### 1) h2load -c100 -m10

**Port reusing**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 196712.666 |           6.9948 |        98.758 |    9.514257813 |
|    2    | 220055.094 |           4.6052 |       146.156 |    9.423828125 |
|    4    | 214679.334 |            3.329 |       151.404 |      9.4296875 |
|    8    | 207702.494 |           3.5508 |       164.488 |     9.51796875 |

**Acceptor/worker**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 199005.834 |           6.3428 |         99.07 |    9.519335938 |
|    2    | 219053.934 |           4.0376 |       140.308 |     9.49453125 |
|    4    | 210013.102 |           3.3358 |       143.344 |    9.295898438 |
|    8    |  209466.56 |           3.5956 |       166.562 |    9.462109375 |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 17](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 19](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 21](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_5.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 23](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_7.png)  

### 2) h2load -c1000 -m100

**Port reusing**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    |  224862.99 |         384.2416 |        99.626 |    76.52480469 |
|    2    | 404943.208 |         307.5908 |        192.06 |    94.28222656 |
|    4    | 438058.332 |         160.4104 |       217.454 |    89.04765625 |
|    8    |     435534 |          156.368 |       218.666 |      81.909375 |

**Acceptor/worker**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 225519.504 |         501.1668 |        99.724 |    97.57636719 |
|    2    | 406958.212 |         281.1706 |       187.632 |    94.61152344 |
|    4    |     451179 |         153.3158 |       214.998 |    89.13046875 |
|    8    | 445782.332 |          146.397 |       219.958 |     80.2796875 |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 18](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 20](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_4.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 22](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_6.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 24](/assets/img/projects/h2_server/h2c_sock_re_acpt_worker_8.png)  


## 4.2 ì„œë²„ í”„ë¡œê·¸ë¨ ê°„ ì„±ëŠ¥ ë¹„êµ

- h2server commit: `c34cd1d9ce9`
- nghttpd: nghttp2 v1.60.0  
- libevent-server: nghttp2 v1.60.0

ìš”ì•½:
- `nghttpd`ëŠ” ìŠ¤ë ˆë“œ ì¦ê°€ì— ë”°ë¥¸ **ë©”ëª¨ë¦¬ ì•ˆì •ì„±**ì´ ë†’ì§€ë§Œ **ì„±ëŠ¥ ìŠ¤ì¼€ì¼ë§ ì´ë“ì€ ì œí•œì **
- `h2server`ëŠ” ìŠ¤ë ˆë“œ ì¦ê°€ì™€ í•¨ê»˜ **CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€**í•˜ë‚˜ **ì²˜ë¦¬ëŸ‰ë„ ë™ë°˜ ì¦ê°€**


### 4.2.1. Single Thread
2server, nghttpd, libevent ê°„ ì„±ëŠ¥ì„ ë¹„êµ.  
libeventì˜ ê²½ìš° h2c ëª¨ë“œë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ h2 í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì œì™¸.  

### 4.2.1.1. H2

---

### 1) h2load -c100 -m10

| Server          | QPS       | P99 Latency (ms) | P90 Latency (ms) | P50 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-------------- | :-------- | :--------------- | :--------------- | :--------------- | :------------ | :------------- |
| h2server        | 173702.09 | 7.30             | 5.9562           | 5.02             | 99.20         | 18.12          |
| Libevent-server | 154655.1  | 10.07            | 7.18             | 5.50             | 98.02         | 15.41          |
| nghttpd         | 181680    | 6.08             | 4.15             | 2.79             | 90.942        | 18.23          |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 25](/assets/img/projects/h2_server/h2_serves_cmp_low_1_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 26](/assets/img/projects/h2_server/h2_serves_cmp_low_1_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 27](/assets/img/projects/h2_server/h2_serves_cmp_low_1_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 28](/assets/img/projects/h2_server/h2_serves_cmp_low_1_4.png)  

### 2) h2load -c1000 -m100

| Server          | QPS       | P99 Latency (ms) | P90 Latency (ms) | P50 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-------------- | :-------- | :--------------- | :--------------- | :--------------- | :------------ | :------------- |
| h2server        | 205574.33 | 547.78           | 508.38           | 486.71           | 99.94         | 141.19         |
| Libevent-server | 204798.99 | 541.53           | 507.15           | 479.89           | 99.91         | 95.45          |
| nghttpd         | 321848.43 | 235.78           | 166.42           | 157.61           | 85.59         | 112.38         |


![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 29](/assets/img/projects/h2_server/h2_serves_cmp_high_1_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 30](/assets/img/projects/h2_server/h2_serves_cmp_high_1_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 31](/assets/img/projects/h2_server/h2_serves_cmp_high_1_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 32](/assets/img/projects/h2_server/h2_serves_cmp_high_1_4.png)  
  
### 4.2.1.2. H2C

---

### 1) h2load -c100 -m10

| Server   | QPS       | P99 Latency (ms) | P90 Latency (ms) | P50 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :------- | :-------- | :--------------- | :--------------- | :--------------- | :------------ | :------------- |
| h2server | 192895.76 | 6.70             | 5.50             | 4.52             | 99.07         | 9.56           |
| nghttpd  | 205405.52 | 5.65             | 3.94             | 2.48             | 91.77         | 14.84          |



![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 33](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 34](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 35](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 36](/assets/img/projects/h2_server/h2c_serves_cmp_low_1_4.png)  

### 2) h2load -c1000 -m100

| Server   | QPS       | P99 Latency (ms) | P90 Latency (ms) | P50 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :------- | :-------- | :--------------- | :--------------- | :--------------- | :------------ | :------------- |
| h2server | 221886.06 | 514.82           | 474.64           | 445.10           | 99.93         | 96.42          |
| nghttpd  | 375828.33 | 254.24           | 213.16           | 134.79           | 91.04         | 75.29          |

![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 37](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 38](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 39](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 40](/assets/img/projects/h2_server/h2c_serves_cmp_high_1_4.png)  
  

### 4.2.2 ìŠ¤ë ˆë“œ ìŠ¤ì¼€ì¼ë§ ë¹„êµ
- `libevent-server`ëŠ” ë©€í‹°ìŠ¤ë ˆë“œ ë¯¸ì§€ì› â†’ ì œì™¸
- `nghttpd`ëŠ” 8ìŠ¤ë ˆë“œì—ì„œ FD ë¶€ì¡± ì´ìŠˆ â†’ `ulimit -n 65535`ë¡œ ìƒí–¥í•˜ì—¬ ì¸¡ì •


### 4.2.2.1 H2
### 1) h2load -c100 -m10

**h2server**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 173702.098 |            7.306 |        99.208 |    18.12363281 |
|    2    | 187681.734 |           4.2538 |       139.288 |    18.12070313 |
|    4    | 178973.032 |           4.4518 |        155.91 |    18.06914063 |
|    8    | 172458.585 |           4.4838 |       166.854 |     18.3203125 |


**nghttpd**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    |     181680 |            6.083 |        90.942 |    18.22597656 |
|    2    | 179038.566 |           4.3452 |       108.585 |     18.2668457 |
|    4    | 174970.764 |           4.2538 |       119.614 |    18.61054688 |
|    8    | 171352.502 |             4.23 |      130.3475 |      19.821875 |


![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 41](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 43](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 45](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_5.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 47](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_7.png)  

---

### 2) h2load -c1000 -m100

**h2server**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 205574.332 |         547.7828 |        99.942 |    141.1904297 |
|    2    | 393091.732 |         305.2898 |       194.396 |    136.2841797 |
|    4    | 403797.186 |         157.3542 |       203.208 |    141.8414063 |
|    8    | 404569.212 |          152.979 |        214.93 |    143.1271484 |


**nghttpd**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    |  321848.43 |          235.788 |         85.59 |    112.3808594 |
|    2    | 358788.664 |         188.0264 |       105.616 |    116.7830078 |
|    4    |   367662.9 |          177.935 |        113.07 |    115.0414063 |
|    8    | 348835.566 |         182.8562 |       122.024 |    112.4423828 |


![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 42](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_2.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 44](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_4.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 46](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_6.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 48](/assets/img/projects/h2_server/h2_svr_nghttpd_cmp_8.png)  

---

### 4.2.2.2 H2C
### 1) h2load -c100 -m10

**h2server**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 192895.766 |           6.7044 |        99.078 |    9.565039063 |
|    2    |   216457.4 |           4.2202 |       148.056 |    9.491796875 |
|    4    | 202325.634 |           3.7672 |       154.126 |    9.574414063 |
|    8    |  199447.33 |           3.4988 |        168.01 |    9.599609375 |


**nghttpd**

| Threads |         QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ----------: | ---------------: | ------------: | -------------: |
|    1    |  205405.524 |           5.6562 |         91.77 |    14.84101563 |
|    2    |  198241.198 |           3.7884 |       104.036 |    12.01835938 |
|    4    |   195620.47 |           3.8596 |       115.082 |     12.3109375 |
|    8    | 192671.3117 |        3.5740383 |   118.5828333 |    11.59673754 |


![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 49](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_1.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 51](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_3.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 53](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_5.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 55](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_7.png)  

---

### 2) h2load -c1000 -m100

**h2server**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 221886.068 |          514.821 |        99.938 |     96.4296875 |
|    2    | 410807.138 |         274.1966 |       193.756 |    94.84179688 |
|    4    | 428543.664 |         154.3328 |        219.22 |    91.43515625 |
|    8    |     429380 |         144.1536 |       225.902 |    81.98554688 |

**nghttpd**

| Threads |        QPS | P99 Latency (ms) | CPUÂ Usage (%) | Mem Usage (MB) |
| :-----: | ---------: | ---------------: | ------------: | -------------: |
|    1    | 375828.332 |         254.2466 |        91.048 |    75.29472656 |
|    2    |     377719 |         243.6276 |        87.612 |    75.25371094 |
|    4    | 400143.366 |         241.7932 |        90.768 |    75.19921875 |
|    8    | 352529.364 |         264.8662 |        85.352 |    75.21660156 |


![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 50](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_2.png)   
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 52](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_4.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 54](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_6.png)  
![http2 ì„œë²„ ìŠ¤í¬ë¦°ìƒ· 56](/assets/img/projects/h2_server/h2c_svr_nghttpd_cmp_8.png)  
